---
- hosts: leaf
  connection: httpapi
  gather_facts: false
  collections:
    - dellemc.enterprise_sonic

  vars:
    leafcount: "{{ groups['leaf'] | length }}"
    spinecount: "{{ groups['spine'] | length }}"
    switchcount: "{{leafcount|int+spinecount|int}}"

  tasks: 

    - name: Read group_vars/all.yml, count total leafs...
      set_fact:
        groupalldata: "{{lookup('file', 'group_vars/all.yaml') }}"
      
        #      vars:
        #        leafcount: "{{ groupalldata | regex_findall('vtep_name') | length }}"

    - name: Request vxlan tunnel status...
      vars:
        ansible_connection: network_cli
      any_errors_fatal: true
      sonic_command:
        commands:
          - show vxlan tunnel 

      register: vxlan_log
      when: leafcount|int > 2

    - name: Check BGP routes of Loopbacks
      vars:
        ansible_connection: network_cli
      any_errors_fatal: true
      sonic_command:
        commands:
          - show ip route bgp | grep /32

      register: bgp_log
      when: leafcount|int <= 2
      
    - name: Print log results vxlan tunnels
      vars:
        tunnelcount: "{{ vxlan_log.stdout_lines[0] | regex_findall('oper_up') | length }}"

      debug:
        var: vxlan_log
      when: leafcount|int > 2

    - name: Print log results BGP routes
      debug:
              #var: bgp_log
              var: switchcount
      when: leafcount|int <= 2

    - name: Valid operational state for VXLAN

      debug:
        msg: "Vtep tunnels are 'oper_up' and in sync with all leafs ({{leafcount}}"
      when: leafcount|int > 2 and leafcount|int-1 == tunnelcount|int
      #failed_when: (leafcount-1|int != tunnelcount|int)

    - name: Invalid operational state for VXLAN

      fail:
        msg: "FAIL: Not all Vtep tunnels ({{ tunnelcount }}) detected. Config fault or switch down?"
      when: leafcount|int > 2 and leafcount|int-1 != tunnelcount|int

    - name: Valid operational state for BGP routes
      vars:
         loopbacks: "{{ bgp_log.stdout_lines[0] | regex_findall('B') | length }}"
      debug:
        msg: "All Loopback routes visible on {{inventory_hostname}} : [{{loopbacks}} routes]"
      when: leafcount|int <= 2 and loopbacks|int >= switchcount|int-1

    - name: Invalid operational state for BGP routes
      vars:
         loopbacks: "{{ bgp_log.stdout_lines[0] | regex_findall('B') | length }}"
      fail:
        msg: "FAIL: Not All Loopback routes visible on {{inventory_hostname}} : [{{loopbacks}} routes]"
      when: leafcount|int <= 2 and loopbacks|int < switchcount|int-1
